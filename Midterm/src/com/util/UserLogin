package com.util;

import java.awt.HeadlessException;
import java.sql.*;

import javax.swing.*;

public class UserLogin {
	
    String userLogin = null;
	String userPassword = null;
	ResultSet rs = null;
	ConnectToDB dbConnection;
	
	

	public UserLogin() throws HeadlessException, SQLException {
		
		// connect to DB
		try {

            dbConnection = new ConnectToDB("localhost//Players", "root", "$up3RmAr10!");

        } catch (SQLException e) {

            JOptionPane.showMessageDialog(null, e.getMessage() + "SQL State: "

                    + e.getSQLState() + " ErrorCode: " + e.getErrorCode(), "Car Racing Game",

                    javax.swing.JOptionPane.WARNING_MESSAGE);

        }
		
		// check if user defined login and password are valid
		if(isValidLogin()) {
			
			// TODO: open page to play game
		// inform user after 3 falied attempts that they have been locked out of the database	
		} else {
			
			JOptionPane.showConfirmDialog(null, "Your account has been locked\n Please contact your Database "
					+ "Administrator", "Car Racing Game", JOptionPane.INFORMATION_MESSAGE);
			try {
				
				dbConnection.executeUpdate(String.format("UPDATE Players SET Password = 'xxxxxx' WHERE Login = '%s'", userLogin));
				
			} catch (SQLException e) {
				
				e.printStackTrace();
			}
		}
	}
	
	public boolean isValidLogin() throws HeadlessException, SQLException {
		
		boolean valid = false;
		
		// check for valid login and password combo 3 times
		for(int i = 0; i < 2; i++) {
		
			// Create pop up window for user to enter login and password
			JLabel loginLabel = new JLabel("User Login: ");
			JTextField login = new JTextField();
			JLabel passwordLabel = new JLabel("Password: ");
			JTextField password = new JPasswordField();
			Object [] userInput = {loginLabel, login, passwordLabel, password};
			
			// show login pop window to user
			JOptionPane.showConfirmDialog(null, userInput, "Please enter your login and password", 
					JOptionPane.QUESTION_MESSAGE);
			
			// capture user data
			userLogin = login.getText();
			userPassword = password.getText();
			
			// check existence of user login
			try {
				
				rs = dbConnection.executeQuerry(String.format("SELECT * FROM ProgDB72358 WHERE Login = '%s'", userLogin));	
				
			} catch (SQLException e) {
				
				e.printStackTrace();
			}
		
			
			// check password
			if(rs != null && rs.getString("Password") == userPassword) {
				
				valid = true;
				break;
				
			
			//	inform user that user login and/or password are incorrect
			} else {
				
				JOptionPane.showConfirmDialog(null, "The Login and Password are not correct\n Please try again"
						+ "if you are already registered or complete your registration if you are not", "Car Racing Game", 
						JOptionPane.INFORMATION_MESSAGE);
				
			}
		}
		
		// returns true if valid user login and password are given, false if not
		return valid;
		
	}
	
}
